# 역직렬화에 실패하는 경우

## 접근 제어자 확인

Jackson은 기본적으로 public 인스턴스 필드만 직렬화/역직렬화 할 수 있다.
public이 아닌 인스턴스 필드를 직렬화/역직렬화하기 위해선 getter를 생성해야한다. 혹은 역직렬화만 하고 싶은 경우 setter를 생성한다.

혹은 [ObjectMapper의 설정을 변경](https://www.baeldung.com/jackson-field-serializable-deserializable-or-not#make-all-fields-globally-serializable)
하는 방법도 있다.

## 기본 생성자가 없는 경우

Jackson은 기본적으로 역직렬화를 하기 위해 Java reflection을 사용한다. 따라서 기본 생성자가 없다면 역직렬화 할 수 없다.

이를 해결하기 위한 방법은 두 가지이다.

### 기본 생성자를 생성한다.

이 경우 인스턴스 필드를 `final`로 선언할 수 없다.

```java
public class Student {

    private String name;
    private double grade;

    private Student() { // private 권장
    }

    public Student(
        final String name,
        final double grade
    ) {
        this.name = name;
        this.grade = grade;
    }

    /* getter */
}
```

### parameter-names module을 설정한다.

인스턴스 필드를 `final`로 사용하고 싶을 때 유용하다.

```java
public class Student {

    private final String name;
    private final double grade;

    /* constructor, getter */
}
```

적용 방법은 다음과 같다.

1. [의존성](https://mvnrepository.com/artifact/com.fasterxml.jackson.module/jackson-module-parameter-names)
   을 추가한다.
2. ObjectMapper에 모듈을 등록한다.

   ```java
   public class Main {
   
       public static void main(String[] args) {
           ObjectMapper objectMapper = new ObjectMapper();
           objectMapper.registerModule(new ParameterNamesModule(JsonCreator.Mode.PROPERTIES));
           
            /* do something */
       }
   }
   ```
3. Java compiler에 `-parameters` 매개변수를 추가한다.

   > Intellij의 경우 `Settings` > `Build, Execution, Deployment` >
   `Compiler` > `Java Compiler` > `Additional command line parameters`에서 추가할 수 있다.

## 생성자가 두 개 이상인 경우

이 경우 어떤 생성자를 이용해야할 지 모르기 때문에 역직렬화 할 수 있다. 이를 해결하기 위한 방법은 다음과 같다.

### `@JsonCreator`를 이용하여 사용할 생성자를 지정한다.

```java
/**
 * parameter-names module을 사용한다고 가정
 */
public class Student {

    private final String name;
    private final double grade;

    @JsonCreator // 직렬화를 위한 생성자 지정
    public Student(
        final String name,
        final double grade
    ) {
        this.name = name;
        this.grade = grade;
    }

    public Student( // 이 생성자를 지정할 수도 있다.
        final String name,
        final double grade,
        final String message
    ) {
        this(name, grade);
        System.out.println("학생이 생성되었습니다.");
    }
}
```

## 매핑을 할 수 없는 경우

JSON의 key와 file 이름이 서로 일치하지 않는 경우 역직렬화 할 수 없다. 이를 해결하기 위한 방법은 다음과 같다.

### @JsonProperty

생성자의 매개 변수에 @JsonProperty를 붙여 매핑한다. 예시는 다음과 같다.

```java
public class Student {

    @JsonProperty("student_name")  // 매핑
    private final String name;
    
    @JsonProperty
    private final double grade;

    public Student(
        final String name,
        final double grade
    ) {
        this.name = name;
        this.grade = grade;
    }
}
```

이때 `grade`와 같이 @JsonProperty의 값와 필드 명이 일치하는 경우 생략할 수 있다.

## parameter-name module 사용 시 유의할 점

* **클래스에 필드가 단 하나 있는 경우 `@JsonProperty`를 반드시 달아야한다. 이는 하휘 호환성 때문이다.**
* parameter-names module은 Java 8 이상부터 동작한다.
* parameter-names module을 이용하고 jackson-databind의 버전이 2.6.X일 경우 `@JsonCreator`를 반드시 달아야한다.

## 참고자료

[FasterXML/modules-java8/parameter-names/README.md](https://github.com/FasterXML/jackson-modules-java8/tree/2.16/parameter-names)

[Jackson – Decide What Fields Get Serialized/Deserialized](https://www.baeldung.com/jackson-field-serializable-deserializable-or-not#make-all-fields-globally-serializable)
