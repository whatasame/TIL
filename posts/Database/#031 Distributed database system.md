# #031 Distributed database system

이번 글에서는 분산형 데이터베이스에 대해 간단하게 알아보도록 하겠습니다.

## 분산형 데이터베이스란?

### 분산형 데이터베이스의 정의

물리적인 요소를 공유하지 않고 결합도가 낮은 site로 구성된 데이터베이스 시스템을 분산형 데이터베이스 시스템이라고 합니다.

- 결합도가 낮다 : loosely coupled
- site : 서버와 같은 시스템의 단위

### 분산형 데이터베이스의 특징

분산형 데이터베이스 시스템의 특징은 아래와 같습니다.

- 각각의 서버(site)들은 서로 독립적이다.
- 분산형 데이터베이스 시스템의 트랜잭션은 하나 이상의 site에 접근할 수 있다.

### 분산형 데이터베이스의 종류

분산형 데이터베이스는 2가지로 구분할 수 있습니다.

- 동질성 분산형 데이터베이스
    - Homogeneous distributed database
    - 각각의 site들이 동일한 S/W를 가지고 있음
    - 각각의 site들이 서로의 존재를 알고 있음
    - 데이터베이스 사용자의 요청(Transaction)을 처리하는데 있어 전적으로 협력함
    - 데이터베이스 사용자들에겐 하나의 시스템으로 보임
- 이질적 분산형 데이터베이스
    - Heterogeneous distributed database
    - 각각의 site들이 서로 다른 스키마와 S/W를 가질 수도 있음
    - 각각의 site들은 서로의 존재를 모를 수도 있음
    - 데이터베이스 사용자의 요청(Transaction)을 처리하는데 있어 제한적으로 협력할 수도 있음
    

## 분산형 데이터베이스의 데이터 저장

분산형 데이터베이스에서 데이터 저장하는 방식의 특징은 아래와 같습니다.

- 관계형 데이터베이스 모델을 따름
- 중복(Replication)하여 저장
- 분(할하ragmentation, Sharding)하여 저장

### 중복

관계형 데이터베이스 모델에서는 데이터의 중복을 허락하지 않습니다. 분산형 데이터베이스 시스템도 관계형 데이터베이스 모델을 따르므로 하나의 site 내에서는 데이터의 중복이 발생하지 않습니다. 

그러나 분산형 데이터베이스 시스템에서는 중복을 허락합니다. 각각의 site는 서로 독립적이므로 시스템 전체에서는 중복이 가능하기 때문이죠.

그렇다면 분산형 데이터베이스 시스템은 어째서 중복을 허락할까요? 중복을 함으로써 시스템 전체의 성능을 향상시킬 수 있기 때문입니다.

예를 들어, 릴레이션 R을 site1과 site2에서 보관한다고 해보겠습니다. 이는 분산형 데이터베이스 시스템에서 릴레이션 R이 중복 저장되었다는 것을 의미합니다.

### 중복의 장단점

이때, 중복의 장점은 아래와 같습니다.

- 가용성(Availability)
    
    트랜잭션이 릴레이션 R에 접근할 때를 생각해보겠습니다. 그런데 마침 site 1의 서비스가 고장났습니다. 그러나 site 2에서 릴레이션 R의 정보를 가지고 있기 때문에 사용자에게 정상적으로 응답을 보낼 수 있습니다.
    
    즉, 시스템 failure를 회복하기 쉬워집니다.
    
- 병렬화(Parallelism)
    
    트랜잭션이 릴레이션 R에 대한 연산을 수행한다고 해보겠습니다. site 1과 site 2가 릴레이션 R의 정보를 가지고 있기 때문에 하나의 트랜잭션 연산을 나누어 site 1과 site 2에서 동시에 진행할 수 있게 됩니다.
    
- 데이터 전송 시간 단축(Reduced data transfer)
    
    이번에는 site 2의 릴레이션 T와 릴레이션 R을 Join 한다고 해보겠습니다. 만약, site 2가 릴레이션 R의 정보를 저장하고 있지 않다면 site 1에 접근하여 릴레이션 R의 데이터를 가지고 와서 Join을 해야할 것입니다.
    
    중복을 함으로써 외부 site에 접근하여 데이터를 가져오지 않아도 된다는 장점이 있습니다.
    

그러나 당연하게도 중복의 단점도 있습니다.

- 갱신 비용 증가(Increased cost of updates)
    
    하나의 릴레이션 R을  두 개의 site에서 저장하고 있기 때문에 R에 대한 수정이 발생하면 site 1과 site 2에 있는 릴레이션 R을 모두 수정해야합니다.
    
- 동시성 제어 복잡도 증가(Increased complexity of concurrency control)
    
    일반적인 동시성 제어 기능은 단일 데이터베이스 시스템을 가정하고 만들어졌기 때문에 분산형 데이터베이스 시스템을 위한 새로운 동시성 제어 알고리즘이 필요합니다. 
    
    데이터 중복으로 인해 동시성 제어에서 고려해야할 것이 늘어나므로 복잡도가 늘어납니다.
    

즉, 중복을 하면 검색 속도는 빨라지지만 갱신 속도는 느려진다고 할 수 있습니다.

### 분할

분할(Fragmentation, Sharding)은 하나의 릴레이션 R을 분할하여 여러 site에서 저장하는 것을 말합니다.

분할의 방법에는 2가지가 있습니다.

- 수평적 분할(Horizontal fragmentation)
    
    수평적 분할은 하나의 릴레이션을 하나 이상의 레코드 묶음으로 저장하는 것을 말합니다.
    
- 수직적 분할(Vertical fragmentation)
    
    수직적 분할은 하나의 릴레이션을 하나 이상의 속성으로 저장하는 것을 말합니다.
    
    다시 말해, 하나의 스키마를 여러 작은 스키마로 나누어 저장합니다.
    

수평적 분할과 수직적 분할을 섞어서 분할할 수도 있습니다.

### 수평적 분할

수평적 분할을 한다는 것은 관계 대수에서 select 연산($\sigma$)을 하여 저장한다는 것을 말합니다.

<p align="center"><img src="../../images/Database/%23031%20Distributed%20database%20system/Untitled.png"></p>

위 그림은 하나의 릴레이션 $account$를 $branch\_name$으로 수평적 분할하여 $account_1$과 $account_2$로 나누고 있습니다.

### 수직적 분할

수직적 분할은 관계 대수에서 produc 연산($\Pi$)을 하여 저장한다는 것을 말합니다.

<p align="center"><img src="../../images/Database/%23031%20Distributed%20database%20system/Untitled%201.png"></p>

위 그림은 하나의 릴레이션 $employee\_info$를 2개의 스키마로 기준으로 2개의 릴레이션으로 나누고 있습니다.

수직적 분할에서 하나의 스키마를 작은 스키마로 나눌 때 각 스키마는 후보 키로 구성되어야합니다. 이는 lossless join을 보장해주기 위함입니다.

위 예제에서는 후보 키인 tuple_id가 각각의 스키마에 포함되어있습니다.

### 분할의 장점

- 수평적 분할의 장점
    - 하나의 릴레이션을 여러 레코드로 분할하여 저장하므로 병렬화를 할 수 있다.
    - 레코드 단위로 저장되므로 해당 레코드를 자주 쓰는 곳에 레코드를 저장하여 성능을 높힐 수 있다.
    → 분할하지 않으면 릴레이션 단위로 저장하거나 릴레이션 단위로 다른 site에서 가져와야함
- 수직적 분할의 장점
    - 하나의 릴레이션을 여러 레코드로 분할하여 저장하므로 병렬화를 할 수 있다.
    - 레코드 단위로 저장되므로 해당 레코드를 자주 쓰는 곳에 레코드를 저장하여 성능을 높힐 수 있다.

## 데이터 투명성

데이터 투명성$^{data\ transparency}$는 데이터베이스 사용자가 이용하는 데이터베이스 시스템이 하나의 데이터베이스 시스템인지, 분산형 데이터베이스 시스템인지 모르게 하는 것을 말합니다.

즉, 분산형 데이터베이스 시스템에서 데이터 투명성을 지키면 데이터베이스 사용자는 하나의 데이터베이스 시스템으로 인식합니다.

데이터 투명성는 3가지로 구분됩니다.

- Fragmentation transparency
- Replication transparency
- Location transparency

## 분산형 트랜잭션

앞서 언급한 것처럼 분산형 데이터베이스 시스템에서는 하나의 트랜잭션을 처리하는 데 있어 여러 site를 접근해야할 수도 있습니다. 이렇게 여러 site를 접근하는 트랜잭션을 분산형 트랜잭션이라고 합니다.

분산형 트랜잭션을 제대로 처리하기 위해선 각 site는 트랜잭션 관리자와 트랜잭션 조정자를 가지고 있어야합니다.

### 트랜잭션 관리자

트랜잭션 관리자$^{trasaction\ manager}$는 다음과 같은 역할을 합니다.

- 회복 시스템을 위한 트랜잭션 로그를 기록
- 현재 site에 실행되고 있는 동시성 트랜잭션 조정에 참여

### 트랜잭션 조정자

트랜잭션 조정자 $^{transaction\ coordinator}$는 다음과 같은 역할을 합니다.

- 분산형 트랜잭션을 시작
- 분산된 트랜잭션을 적절한 site에 분배
- 분산된 트랜잭션이 commit되거나 abort되도록 조정

### 분산형 트랜잭션의 예시

<p align="center"><img src="../../images/Database/%23031%20Distributed%20database%20system/Untitled%202.png"></p>

각각의 서버(site)는 트랜잭션 관리자와 조정자를 하나씩 가지고 있다고 했습니다.

만약 분산형 트랜잭션이 1번에서 시작하면 1번 site의 트랜잭션 조정자는 분산된 트랜잭션에 필요한 site의 트랜잭션 관리자에게 개별의 트랜잭션에 대한 처리를 요청합니다.

## 분산형 데이터베이스 시스템의 회복 시스템

분산형 데이터베이스 시스템에서 중복을 함으로써 새로운 동시성 제어 알고리즘이 필요하듯, 장애$^{failure}$이 발생했을 때 트랜잭션을 복구하는 회복 시스템 또한 분산형 트랜잭션에 맞게 새로운 알고리즘이 필요합니다.

### 장애의 종류

- site의 장애 : site 자체의 장애
- massage의 loss : 애플리케이션이 보내는 massage 패킷의 손실
    
    이는 TCP 통신으로 해결할 수 있습니다.
    
- communication link 장애 : site끼리 연결한 link의 장애
    
    이는 라우팅 알고리즘을 통해 다른 link를 경유하는 방식으로 해결할 수 있습니다.
    
- network partition : 둘 이상의 서브 시스템의 연결이 끊긴 것
    
    서브 시스템은 하나 이상의 노드로 구성될 수 있습니다.
    
    network partition과 site 장애은 일반적으로 구분할 수 없습니다.
    

### Commit protocol

Commit protocol은 분산형 트랜잭션의 장애가 발생했을 때 트랜잭션의 원자성을 보장하기 위한 프로토콜입니다. 

분산형 트랜잭션의 원자성이란 일반 트랜잭션의 원자성과 비슷합니다. 모든 site에서 commit되거나 abort되어야한다는 것을 말합니다.

Commit protocol은 2가지로 구분할 수 있습니다.

- two-phase commit(2PC) : 널리 사용되는 프로토콜입니다.
- three-phase coomit(3PC) : 2PC 프로토콜이 해결할 수 없는 문제점(비잔틴 장애)를 회피할 때 사용하는 프로토콜입니다. 그러나 실전에서 사용되지는 않습니다.

### Two phase commit protocol

2PC 프로토콜은 분산형 트랜잭션을 처리하는 데 있어 2단계를 거쳐서 처리하는 프로토콜입니다.

- Phase 1
    1. 분산형 프로토콜을 시작하는 site의 트랜잭션 조정자가 분산형 트랜잭션에 참여하는 site의 트랜잭션 관리자에게 트랜잭션을 commit할 준비를 하라고 알립니다.
    2. 준비 요청을 받은 site의 트랜잭션 조정자는 트랜잭션 준비라는 로그를 기록합니다.
    3. 
- Phase 2