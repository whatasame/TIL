# #000 질의 처리

이번 글에서는 SQL Query를 처리하는 방법에 대해 알아보도록 하겠습니다.

## 질의 처리

질의 처리$^{query\ processing}$란 DBMS에서 SQL Query를 효과적으로 처리하는 것을 말합니다. DBMS에서 질의 처리하는 과정은 아래 그림과 같습니다.

<p align="center"><img src="../../images/데이터베이스/%23000%20%EC%A7%88%EC%9D%98%20%EC%B2%98%EB%A6%AC/Untitled.png"></p>

1. **Query** : 질의 `SELECT balance FROM account WHERE balance < 2500`
2. Parser : Query가 DBMS에서 정한 SQL 문법을 따랐는지 검사한다.
3. Translator : Query를 관계 대수 표현식$^{relational\ algebra\ expression}$으로 변경한다.
4. **Relational Algebra Expression** : 관계 대수 표현식. 하나의 SQL은 여러 관계 대수로 표현될 수 있다.
    
    $$
    \sigma_{balance<2500}(\Pi_{balance}(account))\\\Pi_{balance}(\sigma_{balance<2500}(account))
    $$
    
5. Optimizer : 여러 개의 관계 대수 중 가장 비용이 적은 관계 대수를 고른다.
6. **Execution Plan** : 최종 선택된 관계 대수
7. Evaluation Engine : 테이블의 통계 데이터를 보고, 관계 대수를 처리하는 방법을 선택한다.
8. **Query Output** : 질의의 결과

### 질의 최적화

질의 최적화$^{query\ optimization}$은 주어진 질의에 대한 최선의 실행 방법을 발견하는 것으로서 질의 처리 중 Optimizer 단계에서 수행하는 작업입니다.

질의 최적화 단계에서는 가장 비용이 적은 관계 대수를 고릅니다. 이때, 가장 비용이 적다는 것에 유의해야합니다. 예를 들어 하나의 SQL에서 다음과 같은 관계 대수가 생성되었다고 해봅시다.

<p align="center"><img src="../../images/데이터베이스/%23000%20%EC%A7%88%EC%9D%98%20%EC%B2%98%EB%A6%AC/Untitled%201.png"></p>

위 표에서 실행 시간이 가장 짧은 관계 대수는 1번 관계 대수입니다. 그러나, 질의 최적화에 있어 비용이란 실행 시간과 찾는 시간의 합을 말합니다. 따라서, 질의 최적화 단계에서 선택되는 관계 대수는 2번 관계 대수입니다. 즉, 실행 시간이 가장 빠른 관계 대수가 있다 하더라도 해당 관계 대수를 찾는 데 시간이 오래 걸린다면 적당히 쓸만한 관계 대수를 선택한다는 것입니다.

과거에는 이러한 질의 최적화를 프로그래머가 직접 수행해야 했지만, 요즘 사용되는 관계형 데이터베이스에서는 DBMS가 알아서 처리합니다. 그렇기 때문에 DBMS의 품질의 따라 질의 처리 속도가 천차만별로 차이나는 것입니다.

## Evaluation Engine

질의 처리 단계에서 Evaluation Engine은 대상 테이블의 통계 데이터에 따라 관계 대수를 처리하는 방법을 선택합니다. 예를 들어, SELELCT를 수행할 때 통계 데이터를 보고 인덱스를 사용할 것인지 판단합니다.

### 용어 정리

Evaluation Engine에서 사용되는 용어는 아래와 같습니다.

- $n_r$ : 테이블의 레코드 수
- $b_r$ : 테이블의 레코드들을 저장하는 데 사용한 블럭의 수
- $s_r$ : 테이블의 레코드의 바이트 크기
- $f_r$ : 하나의 블럭에 저장된 레코드 수. $(b_r=\lceil n_r/f_r\rceil)$

- $V(A,r)$ : 속성 $A$을 구별하는데 사용되는 값 $r$들의 개수
    
    예를 들어, $n_r$이 30일 때, $A$가 주 키일 경우 $V(A,r)=30$이고, A가 성별일 경우$V(A,r)=2$입니다.
    
- $SC(A,r)$ :